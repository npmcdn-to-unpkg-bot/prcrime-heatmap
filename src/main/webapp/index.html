<!DOCTYPE html>
<html>
<head>
    <title>Puerto Rico Crime Heatmap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet-src.js"></script>
    <script type="text/javascript" src="jslib/momentjs/moment.js"></script>
    <script type="text/javascript" src="jslib/heatmap/build/heatmap.js"></script>
    <script type="text/javascript" src="jslib/heatmap/plugins/leaflet-heatmap.js"></script>

    <script type="text/javascript">

        var DEFAULTS = {
            CENTER: [18.430189, -66.060061],
            ZOOM: 13,
            MIN_ZOOM: 10,
            MAX_ZOOM: 19,
            BOUNDS: [[18.352687, -66.179752],[18.477284, -65.928097]]
        };

        var cfg = {
            maxOpacity: 1,
            // scales the radius based on map zoom
            radius: 1,
            blur: 0.85,
            scaleRadius: true,
            // if set to false the heatmap uses the global maximum for colorization
            // if activated: uses the data maximum within the current map boundaries
            //   (there will always be a red spot with useLocalExtremas true)
            useLocalExtrema: false,
            // which field name in your data represents the latitude - default "lat"
            latField: 'lat',
            // which field name in your data represents the longitude - default "lng"
            lngField: 'lng',
            // which field name in your data represents the data value - default "value"
            valueField: 'count'
        };

        var map;
        var heatmapLayer;

        $(document).ready(function() {

            map = L.map('map', {
                center: DEFAULTS.CENTER,
                zoom: DEFAULTS.ZOOM
                });

            var url = 'http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png'; //mapquest
            L.tileLayer(url, {
                minZoom: DEFAULTS.MIN_ZOOM,
                maxZoom: DEFAULTS.MAX_ZOOM,
                maxBounds: DEFAULTS.BOUNDS,
                attribution: 'Tiles courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a>, '
                        + '<a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap Contributors</a>',
                subdomains: ['otile1','otile2','otile3','otile4']
            }).addTo(map);

            $.getJSON('app/tipologia.json', function(data) {
                var $incidentTypes = $('#incidentTypes');
                $incidentTypes.attr('size', data.incidentTypes.length + 1);
                for (var i = 0; i < data.incidentTypes.length; i++) {
                    var incidentType = data.incidentTypes[i];
                    var $option = $('<option></option>');
                    $option.text(incidentType.name);
                    $option.val(incidentType.name);
                    $incidentTypes.append($option);
                }
            });


            var $daysOfWeek = $('#daysOfWeek');
            $daysOfWeek.attr('size', 7);
            for (var i = 1; i < 8; i++) {
                var day = moment().day(i);
                var $option = $('<option></option>');
                $option.text(day.format('dddd'));
                $option.val(day.day());
                $daysOfWeek.append($option);
            }

            updateHeatmap();
            map.on('viewreset', function() {
                updateHeatmap();
            });
            map.on('moveend', function() {
                updateHeatmap();
            });
        });

        function removeEmptyString(arrayOfStrings) {
            var idx = arrayOfStrings.indexOf('');
            if (idx > -1) {
                arrayOfStrings.splice(idx, 1);
            }
        }

        function updateHeatmap() {
            var bounds = map.getBounds();
            var daysOfWeek = $('#daysOfWeek').val();
            removeEmptyString(daysOfWeek);


            var incidentTypes = $('#incidentTypes').val();
            removeEmptyString(incidentTypes);
            var criteria = {
                bboxXmin: bounds.getSouthWest().lng,
                bboxYmin: bounds.getSouthWest().lat,
                bboxXmax: bounds.getNorthEast().lng,
                bboxYmax: bounds.getNorthEast().lat,
                daysOfWeek: daysOfWeek.length > 0 && daysOfWeek || null,
                timeMin: $('#timeMin').val(),
                timeMax: $('#timeMax').val(),
                dateMin: $('#dateMin').val(),
                dateMax: $('#dateMax').val(),
                incidentTypes: incidentTypes.length > 0 && incidentTypes || null,
                limit: $('#limit').val()
            };

            $.ajax('app/incidentes.json', {
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                method: 'POST',
                data: JSON.stringify(criteria),
                success: function (data) {

                    cfg.radius = parseInt($('#heatRadius').val()) * 0.0001;
                    cfg.useLocalExtrema = $('#useLocalExtrema').prop('checked');
                    var newHeatmapLayer = new HeatmapOverlay(cfg);

                    var dataSet = [];
                    if(data.features.length > 0) {
                        $('#resultFechaMin').text(data.features[data.features.length - 1].properties.date)
                        $('#resultFechaMax').text(data.features[0].properties.date)
                    }

                    for (var i = 0; i < data.features.length; i++) {
                        var coords = data.features[i].geometry.coordinates;
                        dataSet.push({
                            lat: coords[1],
                            lng: coords[0]
                        })
                    }

                    if(heatmapLayer) {
                        map.removeLayer(heatmapLayer);
                    }
                    heatmapLayer = newHeatmapLayer;
                    map.addLayer(newHeatmapLayer);

                    var heatMapData = {
                        data: dataSet
                    };
                    if (!criteria.useLocalExtrema) {
                        heatMapData.max = parseInt($('#maxima').val());
                    }

                    newHeatmapLayer.setData(heatMapData);
                }
            });
        }
    </script>

</head>
<body>
<table style="width: 100%">
    <tr>
        <td style="width: 20%; vertical-align: top">
            <h2>Puerto Rico Crime Heatmap</h2>
            <fieldset>
                <table>
                    <tr>
                        <td><label for="incidentTypes">Tipo de incidente</label></td>
                        <td>
                            <select id="incidentTypes" multiple>
                                <option value="" selected>-- Todos --</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="dateMin">Fecha m&iacute;nima</label></td>
                        <td><input type="date" id="dateMin"/></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td id="resultFechaMin">&nbsp;</td>
                    </tr>
                    <tr>
                        <td><label for="dateMax">Fecha m&aacute;xima</label></td>
                        <td><input type="date" id="dateMax"/></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td id="resultFechaMax">&nbsp;</td>
                    </tr>
                    <tr>
                        <td><label for="timeMin">Hora m&iacute;nima</label></td>
                        <td><input type="time" id="timeMin"/></td>
                    </tr>
                    <tr>
                        <td><label for="timeMax">Hora m&aacute;xima</label></td>
                        <td><input type="time" id="timeMax"/></td>
                    </tr>
                    <tr>
                        <td><label for="daysOfWeek">D&iacute;a de la semana</label></td>
                        <td>
                            <select id="daysOfWeek" multiple>
                                <option value="" selected>-- Todos --</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="heatRadius">Radio Calor</label></td>
                        <td><input type="range" id="heatRadius" min="1" max="200" value="10"/></td>
                    </tr>
                    <tr>
                        <td><label for="maxima">Densidad M&aacute;xima</label></td>
                        <td>
                            <input type="number" id="maxima" min="1" max="100" value="1" disabled/>
                            <input type="checkbox" id="useLocalExtrema" checked onclick="$('#maxima').prop('disabled', this.checked)"/>
                            <label for="useLocalExtrema">Relativa</label>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="limit">L&iacute;mite Records</label></td>
                        <td><input id="limit" type="number" value="5000" min="1000" max="50000" maxlength="5" step="1000"></td>
                    </tr>

                    <tr>
                        <td></td>
                        <td><button type="button" onclick="updateHeatmap()">Actualizar Mapa!</button></td>
                    </tr>


                </table>

            </fieldset>
        </td>
        <td style="width: 80%">
            <div id="map" style="width: 100%; height: 800px;"></div>
        </td>
    </tr>
</table>
</body>
</html>